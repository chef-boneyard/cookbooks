# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
<%# See http://www.vmware.com/vmtn/resources/238 p. 17 for explanation %>
<% if node[:virtualization][:system] == "vmware" -%>
tinker panic 0
<% end -%>
driftfile /var/lib/ntp/ntp.drift
statsdir /var/log/ntpstats/

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

<%# If this is a server, and ntp.peers is not empty -%>
<% if node[:ntp][:is_server] and ! node[:ntp][:peers].empty? -%>
  <%# Loop through defined peers, but don't peer with ourself -%>
  <% node[:ntp][:peers].each do |ntppeer| -%>
    <% if node[:ipaddress] != ntppeer and node[:fqdn] != ntppeer -%>
peer <%= ntppeer %> iburst
restrict <%= ntppeer %> nomodify
    <% end -%>
  <% end -%>
<% end -%>

<%# Whether this is a client or server, we want upstream servers -%>
<% node[:ntp][:servers].each do |ntpserver| -%>
server <%= ntpserver %> iburst
restrict <%= ntpserver %> nomodify notrap noquery
<% end -%>

restrict default kod notrap nomodify nopeer noquery
restrict 127.0.0.1 nomodify
restrict -6 default kod notrap nomodify nopeer noquery
restrict -6 ::1 nomodify

<%# If this is a server with additional LAN restriction lines, put them here -%>
<% if node[:ntp][:is_server] and ! node[:ntp][:restrictions].empty? -%>
  <% node[:ntp][:restrictions].each do |restriction| -%>
restrict <%= restriction %>
  <% end -%>
<% end -%>

<%# It is best practice to use an high stratum undisciplined clock, if you have a real CMOS clock -%>
<%# Except cases where you have a low stratum server, or a vmware guest without a real CMOS clock -%>
<% if ! node[:ntp][:is_server] and node[:virtualization][:system] != "vmware" -%>
server  127.127.1.0 # local clock
fudge   127.127.1.0 stratum 10
<% end -%>
