server {
  server_name api.doat.com api.prod.doat.com;
  listen 80;
  listen 443 ssl;
  ssl_certificate <%= node[:nginx][:dir] %>/ssl/<%= node[:doat][:web][:ssl_certificate] %>;
  ssl_certificate_key <%= node[:nginx][:dir] %>/ssl/<%= node[:doat][:web][:ssl_certificate_key] %>;
  root /opt/doat/www/gondor;
  error_log <%= node[:nginx][:log_dir] %>/api.doat.com_error.log;
  access_log <%= node[:nginx][:log_dir] %>/api.doat.com_access.log;
  location ~ "\.svn" {
    deny all;
  }
  location / {
    index index.php;
    try_files $uri /index.php?r=$uri&$args;
  }
  location ~ .*\.php(/.*)?$ {
    include fastcgi_params;
    fastcgi_pass <%= if node[:php][:cgi][:binaddress].start_with?("/"); "unix:"; else ""; end + node[:php][:cgi][:bindaddress] %>;
    fastcgi_split_path_info ^(.+\.php)(.*)$;
    fastcgi_param SCRIPT_NAME     $fastcgi_script_name;
    fastcgi_param PATH_INFO       $fastcgi_path_info;
    fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass_header       Set-Cookie;
  }
}

