server {
  listen 80;
  server_name flyapps.me *.flyapps.me;
  
  error_log <%= node[:nginx][:log_dir] %>/flyapps.me_error.log;
  access_log <%= node[:nginx][:log_dir] %>/flyapps.me_access.log;

	rewrite ^/(.*)/(cb[0-9]+)/(.*) /$1/$3 last;
  set $app "";
  if ($http_host ~ "^([^/.]+)\.flyapps.me") {
    set $app $1;
  }
  root /opt/doat/apps/$app;

  location ~* "/_" {
    deny all;
  }

  location ~ "\.svn" {
    deny all;
  }

  location ~ .*\.php(/.*)?$ {
    include fastcgi_params;
    fastcgi_pass <%= if node[:php][:cgi][:binaddress].start_with?("/"); "unix:"; else ""; end + node[:php][:cgi][:bindaddress] %>;
    fastcgi_split_path_info ^(.+\.php)(.*)$;
    fastcgi_param SCRIPT_NAME     $fastcgi_script_name;
    fastcgi_param PATH_INFO       $fastcgi_path_info;
    fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass_header       Set-Cookie;
  }
}
